{% extends "base.html" %}
{% block title %}Äiá»u khiá»ƒn{% endblock %}

{% block content %}
<h2 class="text-2xl font-semibold mb-4">ğŸ® Äiá»u khiá»ƒn tÃ u tá»± hÃ nh</h2>

<div class="bg-white rounded-xl shadow-md p-6 max-w-xl mx-auto">
    <!-- KÃªnh Servo -->
    <label for="channel" class="block text-sm font-medium text-gray-700">Chá»n kÃªnh servo:</label>
    <select id="channel" name="channel" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
        {% for i in range(1, 13) %}
        <option value="{{ i }}">KÃªnh {{ i }}</option>
        {% endfor %}
    </select>

    <!-- GiÃ¡ trá»‹ PWM (Slider) -->
    <label for="pwm" class="block text-sm font-medium text-gray-700 mt-4">
        GiÃ¡ trá»‹ PWM: <span id="pwm-value" class="font-bold text-blue-600">1500</span> Âµs
    </label>
    <input type="range" id="pwm" min="800" max="2200" value="1500" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500">

    <!-- Step -->
    <label for="step" class="block text-sm font-medium text-gray-700 mt-4">Sá»‘ bÆ°á»›c:</label>
    <input type="number" id="step" value="10" min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">

    <!-- Delay -->
    <label for="delay" class="block text-sm font-medium text-gray-700 mt-4">Delay má»—i bÆ°á»›c (ms):</label>
    <input type="number" id="delay" value="50" min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">

    <!-- NÃºt Gá»­i -->
    <button id="submit-btn" class="mt-6 w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition duration-200">
        ğŸš€ Gá»­i lá»‡nh Ä‘iá»u khiá»ƒn
    </button>
    <button id="armed-btn" class="mt-6 w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition duration-200">
        ğŸš€ Gá»­i lá»‡nh ARM
    </button>
    <button id="reboot-btn" class="mt-6 w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition duration-200">
        ğŸš€ Gá»­i lá»‡nh reboot
    </button>

    <!-- Káº¿t quáº£ -->
    <p id="result-msg" class="mt-4 text-center text-sm font-medium text-gray-700"></p>
</div>

<script>
    const pwmSlider = document.getElementById("pwm");
    const pwmValueDisplay = document.getElementById("pwm-value");
    const resultMsg = document.getElementById("result-msg");

    pwmSlider.addEventListener("input", () => {
        pwmValueDisplay.textContent = pwmSlider.value;
    });

    function showResult(success, message) {
        resultMsg.textContent = message;
        resultMsg.classList.toggle("text-green-600", success);
        resultMsg.classList.toggle("text-red-600", !success);
    }

    async function postCommand(url, payload) {
        try {
            const res = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });
            return await res.json();
        } catch {
            return { status: "error" };
        }
    }

    document.getElementById("submit-btn").addEventListener("click", async () => {
        const data = {
            channel: +document.getElementById("channel").value,
            pwm: +pwmSlider.value,
            step: +document.getElementById("step").value,
            delay: +document.getElementById("delay").value,
        };
        const result = await postCommand("/api/send_pwm", data);
        if (result.status === "ok") {
            showResult(true, `âœ… ÄÃ£ gá»­i lá»‡nh tá»›i kÃªnh ${result.channel} vá»›i PWM ${result.pwm}Âµs`);
        } else {
            showResult(false, "âŒ Gá»­i tháº¥t báº¡i. Kiá»ƒm tra káº¿t ná»‘i Pixhawk.");
        }
    });

    let isArmed = false;

    document.getElementById("armed-btn").addEventListener("click", async () => {
        const result = await postCommand("/api/send_custom_command", {
            command_id: 400,
            param1: isArmed ? 0 : 1
        });

        const btn = document.getElementById("armed-btn");
        if (result.status === "ok") {
            isArmed = !isArmed;
            btn.textContent = isArmed ? "ğŸ›‘ Gá»­i lá»‡nh DISARM" : "ğŸš€ Gá»­i lá»‡nh ARM";
            showResult(true, `âœ… ÄÃ£ gá»­i lá»‡nh ${isArmed ? "ARM" : "DISARM"} thÃ nh cÃ´ng.`);
        } else {
            showResult(false, "âŒ Gá»­i lá»‡nh ARM/DISARM tháº¥t báº¡i. Kiá»ƒm tra káº¿t ná»‘i Pixhawk.");
        }
    });

    document.getElementById("reboot-btn").addEventListener("click", async () => {
        const result = await postCommand("/api/send_custom_command", {
            command_id: 246,
            param1: 1
        });

        if (result.status === "ok") {
            showResult(true, "âœ… Lá»‡nh reboot Ä‘Ã£ Ä‘Æ°á»£c gá»­i thÃ nh cÃ´ng.");
        } else {
            showResult(false, "âŒ Gá»­i lá»‡nh reboot tháº¥t báº¡i. Kiá»ƒm tra káº¿t ná»‘i Pixhawk.");
        }
    });
</script>
{% endblock %}
