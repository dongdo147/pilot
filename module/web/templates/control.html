{% extends "base.html" %}

{% block title %}ƒêi·ªÅu khi·ªÉn{% endblock %}

{% block content %}
<!-- Li√™n k·∫øt file CSS ri√™ng cho trang ƒëi·ªÅu khi·ªÉn -->
<link rel="stylesheet" href="../static/css/control.css">

<h2 class="section-title">üéÆ ƒêi·ªÅu khi·ªÉn t√†u t·ª± h√†nh</h2>

<div class="control-container">
    <!-- K√™nh Servo -->
    <label for="channel" class="input-label">Ch·ªçn k√™nh servo:</label>
    <select id="channel" name="channel" class="input-select">
        {% for i in range(1, 13) %}
        <option value="{{ i }}">K√™nh {{ i }}</option>
        {% endfor %}
    </select>

    <!-- Gi√° tr·ªã PWM (Slider) -->
    <label for="pwm" class="input-label">
        Gi√° tr·ªã PWM: <span id="pwm-value" class="pwm-value">1500</span> ¬µs
    </label>
    <input type="range" id="pwm" min="800" max="2200" value="1500" step="1" class="pwm-slider">

    <!-- Step v√† Delay -->
    <div class="input-grid">
        <div>
            <label for="step" class="input-label">S·ªë b∆∞·ªõc:</label>
            <input type="number" id="step" value="10" min="1" class="input-number">
        </div>
        <div>
            <label for="delay" class="input-label">Delay m·ªói b∆∞·ªõc (ms):</label>
            <input type="number" id="delay" value="50" min="1" class="input-number">
        </div>
    </div>

    <!-- Ch·ªçn l·ªánh c·∫ßn g·ª≠i -->
    <label for="command" class="input-label">Ch·ªçn l·ªánh c·∫ßn g·ª≠i:</label>
    <select id="command" name="command" class="input-select">
        <option value="send_pwm">G·ª≠i l·ªánh ƒëi·ªÅu khi·ªÉn PWM</option>
        <option value="armed">G·ª≠i l·ªánh ARM</option>
        <option value="disarmed">G·ª≠i l·ªánh DISARM</option>
        <option value="reboot">G·ª≠i l·ªánh reboot</option>
        <option value="set_param_safety">T·∫Øt BRD_SAFETYENABLE</option>
    </select>

    <!-- N√∫t G·ª≠i -->
    <button id="submit-btn" class="btn btn-submit">
        üöÄ G·ª≠i l·ªánh
    </button>

    <!-- K·∫øt qu·∫£ -->
    <p id="result-msg" class="result-message"></p>
</div>

<script>
    const pwmSlider = document.getElementById("pwm");
    const pwmValueDisplay = document.getElementById("pwm-value");
    const resultMsg = document.getElementById("result-msg");

    pwmSlider.addEventListener("input", () => {
        pwmValueDisplay.textContent = pwmSlider.value;
    });

    function showResult(success, message) {
        resultMsg.textContent = message;
        resultMsg.classList.toggle("text-success", success);
        resultMsg.classList.toggle("text-error", !success);
    }

    async function postCommand(url, payload) {
        try {
            const res = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });
            return await res.json();
        } catch {
            return { status: "error" };
        }
    }

    document.getElementById("submit-btn").addEventListener("click", async () => {
        const command = document.getElementById("command").value;
        let payload;
        let url;

        switch (command) {
            case "send_pwm":
                payload = {
                    channel: +document.getElementById("channel").value,
                    pwm: +pwmSlider.value,
                    step: +document.getElementById("step").value,
                    delay: +document.getElementById("delay").value,
                };
                url = "/api/send_pwm";
                break;
            case "armed":
                payload = { command_id: 400, param1: 1 };
                url = "/api/send_custom_command";
                break;
            case "disarmed":
                payload = { command_id: 400, param1: 0 };
                url = "/api/send_custom_command";
                break;
            case "reboot":
                payload = { command_id: 246, param1: 1 };
                url = "/api/send_custom_command";
                break;
            case "set_param_safety":
                payload = {
                    param_id: "BRD_SAFETYENABLE",
                    param_value: 0
                };
                url = "/api/set_param";
                break;
            default:
                break;
        }

        const result = await postCommand(url, payload);
        if (result.status === "ok") {
            showResult(true, `‚úÖ L·ªánh ${command} ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng.`);
        } else {
            showResult(false, "‚ùå G·ª≠i l·ªánh th·∫•t b·∫°i. Ki·ªÉm tra k·∫øt n·ªëi Pixhawk.");
        }
    });
</script>
{% endblock %}